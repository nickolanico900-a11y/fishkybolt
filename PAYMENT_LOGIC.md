# Логіка оплати Monobank

## Огляд

Сайт використовує Monobank для обробки всіх платежів. Система підтримує два типи товарів:
1. **Товари з участю** (`productToCount: true`) - наліпки
2. **Звичайні товари** (`productToCount: false`) - освітлення, фільтри, електрика тощо

## Процес оплати

### 1. Створення рахунку (`create-monobank-invoice`)
- Користувач заповнює форму замовлення
- Створюється запис у таблиці `orders` зі статусом `pending`
- Генерується інвойс через Monobank API
- Користувач перенаправляється на сторінку оплати Monobank

### 2. Обробка webhook (`monobank-webhook`)
Після оплати Monobank надсилає webhook:

#### Для всіх товарів:
- Оновлюється статус замовлення на `completed`
- Зберігається `invoice_id` та `paid_at`

#### Тільки для товарів з `productToCount: true`:
- Створюються записи в таблиці `sticker_entries`
- Генеруються номери позицій для розіграшу
- Відправляється email з номерами позицій

#### Для товарів з `productToCount: false`:
- Записи в `sticker_entries` НЕ створюються
- Email не відправляється (може бути додано в майбутньому)

### 3. Перевірка статусу (`check-order-status`)
- Сторінка Success опитує цю функцію кожні 3 секунди
- Повертає статус замовлення та позиції (якщо є)
- Для товарів без `productToCount` позиції будуть порожніми

## Важливо

- WayForPay більше не використовується
- Статус замовлення оновлюється завжди, незалежно від `productToCount`
- Помилки при створенні entries не блокують оновлення статусу замовлення
- Система ідемпотентна - повторні webhook не створюють дублікати
